<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บันทึกเที่ยววิ่ง</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.x.x/firebase-firestore-compat.js"></script>

    <style>
        /* --- General Styles & Font --- */
        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            background-color: #e6edf7; /* Light blue-grey background */
            color: #333;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Navbar Styles (Top Navigation) --- */
        .navbar {
            background-color: #1a3c5a; /* Dark blue */
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex; /* Use Flexbox to align Brand and Menu */
            justify-content: space-between; /* Distribute Brand to left, Menu to right */
            align-items: center; /* Vertically center */
            flex-wrap: wrap; /* Wrap on smaller screens */
        }

        .navbar .navbar-brand {
            color: white;
            font-family: 'Kanit', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            text-decoration: none; /* Remove underline */
        }

        .navbar .navbar-brand i {
            margin-right: 10px;
            font-size: 1.8rem;
        }

        .navbar-menu {
            list-style: none; /* Remove bullet point */
            margin: 0;
            padding: 0;
            display: flex; /* Use Flexbox for menu items */
            gap: 20px; /* Spacing between menu items */
        }

        .navbar-menu li a {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-decoration: none;
            padding: 8px 12px; /* Add padding for easier clicking */
            transition: color 0.3s ease, text-decoration 0.3s ease;
            display: flex; /* Align icon and text */
            align-items: center;
        }

        .navbar-menu li a i {
            margin-right: 8px; /* Spacing between icon and text */
        }

        .navbar-menu li a:hover,
        .navbar-menu li a.active {
            color: white;
            text-decoration: underline;
            text-underline-offset: 4px;
            text-decoration-thickness: 2px;
        }

        .navbar-menu li a.disabled {
            color: rgba(255, 255, 255, 0.4); /* Faded color for disabled */
            pointer-events: none; /* Disable clicks */
            cursor: not-allowed;
            position: relative;
        }

        .navbar-menu li a.disabled .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Tooltip position above link */
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .navbar-menu li a.disabled:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Responsive adjustments for Navbar */
        @media (max-width: 991.98px) {
            .navbar {
                flex-direction: column; /* Stack vertically on small screens */
                align-items: flex-start;
            }
            .navbar-menu {
                flex-direction: column; /* Vertical menu items */
                width: 100%;
                margin-top: 15px;
                gap: 0; /* Remove original gap */
            }
            .navbar-menu li {
                width: 100%;
            }
            .navbar-menu li a {
                padding: 10px 0;
                width: 100%;
                text-align: left;
            }
        }


        .container {
            max-width: 1200px;
            margin: 25px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        h1 {
            color: #1a3c5a;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
            position: relative;
            padding-bottom: 10px;
        }
        h1::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background-color: #007bff;
            border-radius: 2px;
        }
        .form-section, .table-section {
            padding: 25px;
            border-radius: 12px;
            background-color: #f8f9fa;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        .btn-primary { background-color: #007bff; border-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; border-color: #004085; }
        .btn-success { background-color: #28a745; border-color: #28a745; }
        .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }
        .btn-info { background-color: #17a2b8; border-color: #17a2b8; color: white;}
        .btn-info:hover { background-color: #138496; border-color: #117a8b; }
        .btn-warning { background-color: #ffc107; border-color: #ffc107; color: #212529;}
        .btn-warning:hover { background-color: #e0a800; border-color: #d39e00; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }

        .table-responsive {
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        .table {
            width: 100%;
            margin-bottom: 0;
            border-collapse: separate;
            border-spacing: 0;
        }
        .table thead th {
            background-color: #1a3c5a;
            color: #fff;
            padding: 15px 12px;
            vertical-align: middle;
            border-bottom: none;
            font-weight: 600;
            font-size: 0.95em;
            white-space: nowrap;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .table tbody tr:hover {
            background-color: #e2e6ea;
        }
        .table tbody td {
            padding: 12px;
            vertical-align: middle;
            border-top: 1px solid #dee2e6;
            font-size: 0.9em;
            white-space: nowrap;
        }
        .table td.actions {
            text-align: center;
        }
        .table .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
            border-radius: 6px;
            margin: 2px;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        .pagination-container .btn {
            min-width: 40px;
        }
        .pagination-info {
            font-weight: 500;
            color: #555;
        }
        .form-check-inline {
            margin-right: 1.5rem;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .toast {
            border-radius: 0.75rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            color: #fff;
            opacity: 1 !important; /* Ensure toast is always visible after show */
            transform: translateY(0) !important; /* Ensure no unwanted transform */
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .toast-success {
            background-color: #28a745;
        }
        .toast-error {
            background-color: #dc3545;
        }
        .toast-info {
            background-color: #17a2b8;
        }
        .toast-warning { /* Added for oil change warning */
            background-color: #ffc107;
            color: #212529; /* Dark text for warning */
        }
        .toast .toast-icon {
            font-size: 1.25rem;
            margin-right: 10px;
        }
        .toast .toast-body {
            font-size: 1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a class="navbar-brand" href="index.html">
            <i class="fas fa-truck-moving"></i> INSULOGISTICS
        </a>
        <ul class="navbar-menu">
            <li><a href="index.html"><i class="fas fa-home"></i> แดชบอร์ดหลัก</a></li>
            <li><a href="manage_vehicles.html"><i class="fas fa-truck"></i> จัดการรถและคนขับ</a></li>
            <li><a href="record_trip.html" class="active"><i class="fas fa-clipboard-list"></i> บันทึกเที่ยววิ่ง</a></li>
            <li><a href="dashboard.html"><i class="fas fa-chart-line"></i> รายงานภาพรวม</a></li>
            <li><a href="#" class="disabled"><i class="fas fa-map-marker-alt"></i> ติดตามตำแหน่งรถ <span class="tooltip-text">กำลังพัฒนา</span></a></li>
            <li><a href="#" class="disabled"><i class="fas fa-cogs"></i> ตั้งค่า <span class="tooltip-text">ฟังก์ชันนี้ยังไม่เปิดใช้งาน</span></a></li>
        </ul>
    </nav>

    <div class="container">
        <h1>บันทึกเที่ยววิ่ง</h1>

        <div class="form-section">
            <h4 class="mb-3 text-center" style="color: #1a3c5a;"><i class="fas fa-edit"></i> ฟอร์มบันทึกข้อมูล</h4>
            <form id="tripForm">
                <input type="hidden" id="tripId"> <div class="row g-3">
                    <div class="col-md-6">
                        <label for="tripDate" class="form-label">วันที่</label>
                        <input type="date" class="form-control" id="tripDate" required>
                    </div>
                    <div class="col-md-6">
                        <label for="licensePlate" class="form-label">ทะเบียนรถ</label>
                        <select class="form-select" id="licensePlate" required>
                            <option value="">เลือกทะเบียนรถ</option>
                            </select>
                    </div>
                    <div class="col-md-6">
                        <label for="driverName" class="form-label">ชื่อคนขับ</label>
                        <input type="text" class="form-control" id="driverName" readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="vehicleType" class="form-label">ประเภทรถ</label>
                        <input type="text" class="form-control" id="vehicleType" readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="tripType" class="form-label">ประเภทเที่ยววิ่ง</label>
                        <select class="form-select" id="tripType" required>
                            <option value="">เลือกประเภทเที่ยววิ่ง</option>
                            <option value="งานปกติ">งานปกติ</option>
                            <option value="งานไกล">งานไกล</option>
                            <option value="งานต่างจังหวัด">งานต่างจังหวัด</option>
                            <option value="งานจ่ายตลาด">งานจ่ายตลาด</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="startMileage" class="form-label">เลขไมล์เริ่มต้น (กม.)</label>
                        <input type="number" class="form-control" id="startMileage" placeholder="ระบุเลขไมล์เริ่มต้น" required step="0.01">
                    </div>
                    <div class="col-md-6">
                        <label for="endMileage" class="form-label">เลขไมล์สิ้นสุด (กม.)</label>
                        <input type="number" class="form-control" id="endMileage" placeholder="ระบุเลขไมล์สิ้นสุด" required step="0.01">
                    </div>
                    <div class="col-md-6">
                        <label for="distanceDriven" class="form-label">ระยะทางที่วิ่ง (กม.)</label>
                        <input type="text" class="form-control" id="distanceDriven" readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="fuelQuantityLiter" class="form-label">จำนวนน้ำมันที่เติม (ลิตร)</label>
                        <input type="number" class="form-control" id="fuelQuantityLiter" placeholder="ระบุจำนวนลิตร" step="0.01">
                    </div>
                    <div class="col-md-6">
                        <label for="fuelPricePerLiter" class="form-label">ราคาน้ำมัน/ลิตร</label>
                        <input type="number" class="form-control" id="fuelPricePerLiter" placeholder="ระบุราคา/ลิตร" step="0.01">
                    </div>
                    <div class="col-md-6">
                        <label for="fuelCost" class="form-label">ค่าน้ำมันรวม (บ.)</label>
                        <input type="number" class="form-control" id="fuelCost" placeholder="ระบบจะคำนวณอัตโนมัติ" readonly step="0.01">
                    </div>
                    <div class="col-md-6">
                        <label for="otherCostType" class="form-label">ประเภทค่าใช้จ่ายอื่นๆ</label>
                        <select class="form-select" id="otherCostType">
                            <option value="">เลือกประเภท</option>
                            <option value="ค่าผ่านทาง">ค่าผ่านทาง</option>
                            <option value="ค่าที่จอดรถ">ค่าที่จอดรถ</option>
                            <option value="ค่าล้างรถ">ค่าล้างรถ</option>
                            <option value="ค่าซ่อมบำรุง">ค่าซ่อมบำรุง</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="otherCostAmount" class="form-label">จำนวนค่าใช้จ่ายอื่นๆ (บ.)</label>
                        <input type="number" class="form-control" id="otherCostAmount" placeholder="ระบุจำนวนเงิน" step="0.01">
                    </div>
                    <div class="col-12 d-flex justify-content-end gap-2 mt-4">
                        <button type="submit" class="btn btn-primary" id="saveTripBtn"><i class="fas fa-save"></i> บันทึกข้อมูล</button>
                        <button type="button" class="btn btn-secondary" id="clearFormBtn"><i class="fas fa-times-circle"></i> ล้างฟอร์ม</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="form-section">
            <h4 class="mb-3 text-center" style="color: #1a3c5a;"><i class="fas fa-filter"></i> ตัวกรองข้อมูล</h4>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="filterDateStart" class="form-label">จากวันที่</label>
                    <input type="date" class="form-control" id="filterDateStart">
                </div>
                <div class="col-md-4">
                    <label for="filterDateEnd" class="form-label">ถึงวันที่</label>
                    <input type="date" class="form-control" id="filterDateEnd">
                </div>
                <div class="col-md-4">
                    <label for="filterLicensePlate" class="form-label">ทะเบียนรถ</label>
                    <select class="form-select" id="filterLicensePlate">
                        <option value="">ทั้งหมด</option>
                        </select>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2 mt-3">
                    <button type="button" class="btn btn-primary" id="applyFilterBtn"><i class="fas fa-search"></i> ค้นหา</button>
                    <button type="button" class="btn btn-info" id="exportExcelBtn"><i class="fas fa-file-excel"></i> ส่งออก Excel</button>
                    <button type="button" class="btn btn-secondary" id="clearFilterBtn"><i class="fas fa-undo"></i> ล้างตัวกรอง</button>
                </div>
            </div>
        </div>

        <div class="table-section">
            <h4 class="mb-3 text-center" style="color: #1a3c5a;"><i class="fas fa-table"></i> ประวัติเที่ยววิ่ง</h4>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>วันที่</th>
                            <th>ทะเบียนรถ</th>
                            <th>ประเภทรถ</th>
                            <th>คนขับ</th>
                            <th>ประเภทเที่ยววิ่ง</th>
                            <th>ไมล์เริ่มต้น</th>
                            <th>ไมล์สิ้นสุด</th>
                            <th>ระยะทาง (กม.)</th>
                            <th>ลิตร</th>
                            <th>ราคา/ลิตร</th>
                            <th>ค่าน้ำมัน (บ.)</th>
                            <th>ประเภทค่าใช้จ่ายอื่น</th>
                            <th>ค่าใช้จ่ายอื่นๆ (บ.)</th>
                            <th>รวมค่าใช้จ่าย (บ.)</th>
                            <th class="actions">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="tripTableBody">
                        </tbody>
                </table>
            </div>
            <div class="pagination-container">
                <button class="btn btn-outline-primary" id="prevPageBtn"><i class="fas fa-chevron-left"></i> ก่อนหน้า</button>
                <span id="pageInfo" class="pagination-info">หน้า 1 จาก 1</span>
                <button class="btn btn-outline-primary" id="nextPageBtn">ถัดไป <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase Configuration (Using your provided config)
        const firebaseConfig = {
            apiKey: "AIzaSyBgZ3QPiUufeJEmKFD_GsecxHDz34CtwJo",
            authDomain: "logisticsinsu.firebaseapp.com",
            projectId: "logisticsinsu",
            storageBucket: "logisticsinsu.firebasestorage.app",
            messagingSenderId: "239407443769",
            appId: "1:239407443769:web:9477ead4238227f96902e8",
            measurementId: "G-Y4BPSWVZN7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tripsCollection = db.collection('trips');
        const vehiclesCollection = db.collection('vehicles');

        // --- DOM Elements ---
        const tripForm = document.getElementById('tripForm');
        const tripIdInput = document.getElementById('tripId');
        const tripDateInput = document.getElementById('tripDate');
        const licensePlateSelect = document.getElementById('licensePlate');
        const driverNameInput = document.getElementById('driverName');
        const vehicleTypeInput = document.getElementById('vehicleType');
        const tripTypeSelect = document.getElementById('tripType'); // Changed to select
        const startMileageInput = document.getElementById('startMileage');
        const endMileageInput = document.getElementById('endMileage');
        const distanceDrivenInput = document.getElementById('distanceDriven');
        const fuelQuantityLiterInput = document.getElementById('fuelQuantityLiter');
        const fuelPricePerLiterInput = document.getElementById('fuelPricePerLiter');
        const fuelCostInput = document.getElementById('fuelCost');
        const otherCostTypeSelect = document.getElementById('otherCostType'); // New select field
        const otherCostAmountInput = document.getElementById('otherCostAmount'); // New input for amount

        const saveTripBtn = document.getElementById('saveTripBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');

        const filterDateStartInput = document.getElementById('filterDateStart');
        const filterDateEndInput = document.getElementById('filterDateEnd');
        const filterLicensePlateSelect = document.getElementById('filterLicensePlate');
        const applyFilterBtn = document.getElementById('applyFilterBtn');
        const clearFilterBtn = document.getElementById('clearFilterBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');

        const tripTableBody = document.getElementById('tripTableBody');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfoSpan = document.getElementById('pageInfo');

        // --- Global Variables ---
        let vehiclesAndDrivers = []; // Stores vehicle data fetched from Firestore
        let allTrips = []; // Stores all trip data fetched from Firestore, for filtering/pagination
        let currentPage = 1;
        const rowsPerPage = 10;
        const OIL_CHANGE_INTERVAL = 10000; // Kilometers for oil change interval
        const OIL_CHANGE_WARNING_THRESHOLD = 1000; // Kilometers before interval to warn

        // --- Toast Notification Function ---
        function showToast(message, type = 'info', delay = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white border-0 ${type === 'success' ? 'toast-success' : type === 'error' ? 'toast-error' : type === 'warning' ? 'toast-warning' : 'toast-info'}`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="toast-icon fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: delay });
            bsToast.show();
        }

        // --- Utility Functions ---
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getTodayDateForExcel() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // --- Fetch Vehicles and Populate Selects ---
        async function populateVehicleSelects() {
            try {
                const snapshot = await vehiclesCollection.orderBy('licensePlate').get();
                vehiclesAndDrivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Clear existing options
                licensePlateSelect.innerHTML = '<option value="">เลือกทะเบียนรถ</option>';
                filterLicensePlateSelect.innerHTML = '<option value="">ทั้งหมด</option>';

                vehiclesAndDrivers.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.licensePlate;
                    option.textContent = vehicle.licensePlate;
                    licensePlateSelect.appendChild(option);

                    const filterOption = document.createElement('option');
                    filterOption.value = vehicle.licensePlate;
                    filterOption.textContent = vehicle.licensePlate;
                    filterLicensePlateSelect.appendChild(filterOption);
                });
            } catch (error) {
                console.error("Error fetching vehicles:", error);
                showToast('เกิดข้อผิดพลาดในการโหลดข้อมูลรถ', 'error');
            }
        }

        // --- Handle Vehicle Selection (Auto-fill Driver/Type/Start Mileage) ---
        function handleVehicleSelection() {
            const selectedLicensePlate = licensePlateSelect.value;
            const selectedVehicle = vehiclesAndDrivers.find(v => v.licensePlate === selectedLicensePlate);

            if (selectedVehicle) {
                driverNameInput.value = selectedVehicle.driverName || '';
                vehicleTypeInput.value = selectedVehicle.vehicleType || '';
                // Set start mileage to currentMileage of the selected vehicle if it's a new trip
                // And only if the form is not in edit mode
                if (!tripIdInput.value) { 
                    startMileageInput.value = selectedVehicle.currentMileage !== undefined ? selectedVehicle.currentMileage.toFixed(2) : '';
                }
            } else {
                driverNameInput.value = '';
                vehicleTypeInput.value = '';
                if (!tripIdInput.value) {
                    startMileageInput.value = '';
                }
            }
            calculateDistanceAndFuelCost();
        }

        // --- Calculate Distance Driven, Fuel Cost ---
        function calculateDistanceAndFuelCost() {
            const start = parseFloat(startMileageInput.value);
            const end = parseFloat(endMileageInput.value);
            const quantity = parseFloat(fuelQuantityLiterInput.value);
            const price = parseFloat(fuelPricePerLiterInput.value);

            if (!isNaN(start) && !isNaN(end) && end >= start) {
                distanceDrivenInput.value = (end - start).toFixed(2);
            } else {
                distanceDrivenInput.value = '';
            }

            if (!isNaN(quantity) && !isNaN(price)) {
                fuelCostInput.value = (quantity * price).toFixed(2);
            } else {
                fuelCostInput.value = '';
            }
        }

        // --- Form Submission (Save/Update Trip) ---
        tripForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const tripId = tripIdInput.value;
            const tripDate = tripDateInput.value;
            const licensePlate = licensePlateSelect.value;
            const driverName = driverNameInput.value; // Get driverName from input
            const vehicleType = vehicleTypeInput.value; // Get vehicleType from input
            const tripType = tripTypeSelect.value;
            const startMileage = parseFloat(startMileageInput.value);
            const endMileage = parseFloat(endMileageInput.value);
            const fuelQuantityLiter = parseFloat(fuelQuantityLiterInput.value) || 0;
            const fuelPricePerLiter = parseFloat(fuelPricePerLiterInput.value) || 0;
            const fuelCost = parseFloat(fuelCostInput.value) || 0; // Calculated
            const otherCostType = otherCostTypeSelect.value;
            const otherCostAmount = parseFloat(otherCostAmountInput.value) || 0;

            if (!tripDate || !licensePlate || !tripType || isNaN(startMileage) || isNaN(endMileage)) {
                showToast('กรุณากรอกข้อมูลที่จำเป็นทั้งหมด (วันที่, ทะเบียนรถ, ประเภทเที่ยววิ่ง, เลขไมล์เริ่มต้นและสิ้นสุด)', 'error');
                return;
            }
            if (endMileage < startMileage) {
                showToast('เลขไมล์สิ้นสุดต้องมากกว่าหรือเท่ากับเลขไมล์เริ่มต้น', 'error');
                return;
            }

            const tripData = {
                tripDate: tripDate,
                licensePlate: licensePlate,
                driverName: driverName, // Store from input
                vehicleType: vehicleType, // Store from input
                tripType: tripType,
                startMileage: startMileage,
                endMileage: endMileage,
                fuelQuantityLiter: fuelQuantityLiter,
                fuelPricePerLiter: fuelPricePerLiter,
                fuelCost: fuelCost,
                otherCostType: otherCostType,
                otherCostAmount: otherCostAmount,
                totalCost: fuelCost + otherCostAmount, // Calculate total cost
                distanceDriven: endMileage - startMileage,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // For ordering
            };

            try {
                let savedTripId = tripId;
                if (tripId) {
                    // Update existing trip
                    await tripsCollection.doc(tripId).update(tripData);
                    showToast('อัปเดตเที่ยววิ่งเรียบร้อยแล้ว!', 'success');
                } else {
                    // Add new trip
                    const docRef = await tripsCollection.add(tripData);
                    savedTripId = docRef.id;
                    showToast('บันทึกเที่ยววิ่งใหม่เรียบร้อยแล้ว!', 'success');
                }

                // --- Update currentMileage and check for oil change interval for the vehicle ---
                const vehicleRef = vehiclesCollection.where('licensePlate', '==', licensePlate);
                const vehicleSnapshot = await vehicleRef.get();

                if (!vehicleSnapshot.empty) {
                    const vehicleDoc = vehicleSnapshot.docs[0];
                    const currentVehicleData = vehicleDoc.data();
                    
                    let updateVehicleData = { currentMileage: endMileage };

                    // Only update lastOilChangeMileage if it's a new trip or if the mileage has significantly
                    // passed the oil change interval since the last recorded oil change mileage
                    const mileageSinceLastOilChange = endMileage - (currentVehicleData.lastOilChangeMileage || 0);

                    // If it's a new record or if currentMileage is significantly past the lastOilChangeMileage AND has crossed a full interval
                    // (e.g., if last change was at 10000, and current is 20001, it should trigger, but not if it's 19999)
                    if (!tripId || mileageSinceLastOilChange >= OIL_CHANGE_INTERVAL) {
                        // Check if an oil change notification is needed
                        // This logic determines if the *last* trip recorded for this vehicle crossed an interval.
                        // For simplicity, if we record a trip and it crosses the 10k mark from the *last oil change*,
                        // we can prompt to update the lastOilChangeMileage.
                        
                        // We need to be careful not to reset lastOilChangeMileage unless an actual oil change happened.
                        // The prompt should tell the user to manually update lastOilChangeMileage in manage_vehicles.html
                        // This part here is just for *notification*
                        
                        // Let's refine the notification logic:
                        if (currentVehicleData.lastOilChangeMileage === undefined || currentVehicleData.lastOilChangeMileage === null) {
                            showToast(`รถ ${licensePlate} ยังไม่มีข้อมูลเลขไมล์เปลี่ยนน้ำมันเครื่องล่าสุด! กรุณาเพิ่มข้อมูลในหน้าจัดการรถ`, 'warning', 7000);
                        } else {
                            const remainingMileage = OIL_CHANGE_INTERVAL - (endMileage - currentVehicleData.lastOilChangeMileage);
                            if (remainingMileage <= 0) {
                                showToast(`รถ ${licensePlate} ถึงรอบเปลี่ยนน้ำมันเครื่องแล้ว!`, 'error', 7000); // Use error color for urgent
                            } else if (remainingMileage <= OIL_CHANGE_WARNING_THRESHOLD) {
                                showToast(`รถ ${licensePlate} ใกล้ถึงรอบเปลี่ยนน้ำมันเครื่อง (เหลือประมาณ ${remainingMileage.toLocaleString()} กม.)`, 'warning', 7000);
                            }
                        }
                    }

                    await vehicleDoc.ref.update(updateVehicleData);
                } else {
                    showToast('ไม่พบข้อมูลรถนี้ในระบบ กรุณาเพิ่มรถก่อนบันทึกเที่ยววิ่ง', 'error');
                }

                clearForm();
                await applyFilterAndRender(); // Re-render table after save/update
                await populateVehicleSelects(); // Re-populate to get updated mileage in select
            } catch (error) {
                console.error("Error saving/updating trip:", error);
                showToast('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message, 'error');
            }
        });

        // --- Load Trip for Editing ---
        async function loadTripForEdit(tripDocId) {
            try {
                const tripDoc = await tripsCollection.doc(tripDocId).get();
                if (tripDoc.exists) {
                    const trip = tripDoc.data();
                    tripIdInput.value = tripDoc.id;
                    tripDateInput.value = trip.tripDate;
                    licensePlateSelect.value = trip.licensePlate;
                    driverNameInput.value = trip.driverName || '';
                    vehicleTypeInput.value = trip.vehicleType || '';
                    tripTypeSelect.value = trip.tripType || '';
                    startMileageInput.value = trip.startMileage !== undefined ? trip.startMileage.toFixed(2) : '';
                    endMileageInput.value = trip.endMileage !== undefined ? trip.endMileage.toFixed(2) : '';
                    fuelQuantityLiterInput.value = trip.fuelQuantityLiter !== undefined ? trip.fuelQuantityLiter.toFixed(2) : '';
                    fuelPricePerLiterInput.value = trip.fuelPricePerLiter !== undefined ? trip.fuelPricePerLiter.toFixed(2) : '';
                    fuelCostInput.value = trip.fuelCost !== undefined ? trip.fuelCost.toFixed(2) : '';
                    otherCostTypeSelect.value = trip.otherCostType || '';
                    otherCostAmountInput.value = trip.otherCostAmount !== undefined ? trip.otherCostAmount.toFixed(2) : '';

                    calculateDistanceAndFuelCost(); // Recalculate distance
                    saveTripBtn.textContent = 'อัปเดตข้อมูล';
                    saveTripBtn.classList.remove('btn-primary');
                    saveTripBtn.classList.add('btn-warning');
                    showToast('โหลดข้อมูลเพื่อแก้ไขแล้ว', 'info');
                } else {
                    showToast('ไม่พบข้อมูลเที่ยววิ่ง', 'error');
                }
            } catch (error) {
                console.error("Error loading trip for edit:", error);
                showToast('เกิดข้อผิดพลาดในการโหลดข้อมูลเพื่อแก้ไข: ' + error.message, 'error');
            }
        }

        // --- Delete Trip ---
        async function deleteTrip(tripDocId, licensePlate, endMileageOfDeletedTrip) {
            if (!confirm('คุณแน่ใจหรือไม่ที่จะลบข้อมูลเที่ยววิ่งนี้?')) {
                return;
            }

            try {
                await tripsCollection.doc(tripDocId).delete();
                showToast('ลบข้อมูลเที่ยววิ่งเรียบร้อยแล้ว!', 'success');

                // Recalculate and update currentMileage for the affected vehicle
                const vehicleRef = vehiclesCollection.where('licensePlate', '==', licensePlate);
                const vehicleSnapshot = await vehicleRef.get();
                if (!vehicleSnapshot.empty) {
                    const vehicleDoc = vehicleSnapshot.docs[0];
                    
                    // Find the true latest endMileage for this vehicle after deletion
                    const latestTripSnapshot = await tripsCollection
                        .where('licensePlate', '==', licensePlate)
                        .orderBy('tripDate', 'desc')
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get();
                    
                    let newCurrentMileage = 0; // Default to 0 if no trips exist
                    if (!latestTripSnapshot.empty) {
                        newCurrentMileage = latestTripSnapshot.docs[0].data().endMileage || 0;
                    }
                    
                    // Update only currentMileage, not lastOilChangeMileage automatically on trip deletion
                    await vehicleDoc.ref.update({ currentMileage: newCurrentMileage });
                    showToast(`อัปเดตเลขไมล์ปัจจุบันของรถ ${licensePlate} แล้ว`, 'info');
                }

                await applyFilterAndRender(); // Re-render table after deletion
                await populateVehicleSelects(); // Re-populate to get updated mileage in select
            } catch (error) {
                console.error("Error deleting trip:", error);
                showToast('เกิดข้อผิดพลาดในการลบข้อมูล: ' + error.message, 'error');
            }
        }

        // --- Clear Form ---
        function clearForm() {
            tripForm.reset();
            tripIdInput.value = '';
            tripDateInput.value = getTodayDate(); // Set default date to today
            driverNameInput.value = '';
            vehicleTypeInput.value = '';
            distanceDrivenInput.value = '';
            fuelCostInput.value = '';
            saveTripBtn.textContent = 'บันทึกข้อมูล';
            saveTripBtn.classList.remove('btn-warning');
            saveTripBtn.classList.add('btn-primary');
            licensePlateSelect.value = ''; // Reset license plate select
            startMileageInput.value = ''; // Clear start mileage
            showToast('ล้างฟอร์มเรียบร้อย', 'info');
        }

        // --- Render Table & Pagination ---
        function renderTable() {
            tripTableBody.innerHTML = ''; // Clear existing rows
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const tripsToDisplay = allTrips.slice(startIndex, endIndex);

            if (tripsToDisplay.length === 0) {
                tripTableBody.innerHTML = `<tr><td colspan="15" class="text-center py-4">ไม่พบข้อมูลเที่ยววิ่ง</td></tr>`;
            }

            tripsToDisplay.forEach(trip => {
                const row = tripTableBody.insertRow();
                row.insertCell().textContent = trip.tripDate;
                row.insertCell().textContent = trip.licensePlate;
                row.insertCell().textContent = trip.vehicleType || '';
                row.insertCell().textContent = trip.driverName || '';
                row.insertCell().textContent = trip.tripType || '';
                row.insertCell().textContent = trip.startMileage.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.insertCell().textContent = trip.endMileage.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.insertCell().textContent = trip.distanceDriven.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.insertCell().textContent = trip.fuelQuantityLiter.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.insertCell().textContent = trip.fuelPricePerLiter.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.insertCell().textContent = trip.fuelCost.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.insertCell().textContent = trip.otherCostType || '';
                row.insertCell().textContent = trip.otherCostAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.insertCell().textContent = (trip.fuelCost + trip.otherCostAmount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                const actionsCell = row.insertCell();
                actionsCell.className = 'actions';
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-warning btn-sm me-1';
                editBtn.innerHTML = '<i class="fas fa-edit"></i> แก้ไข';
                editBtn.onclick = () => loadTripForEdit(trip.id);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> ลบ';
                deleteBtn.onclick = () => deleteTrip(trip.id, trip.licensePlate, trip.endMileage);
                actionsCell.appendChild(deleteBtn);
            });

            updatePaginationControls();
        }

        // --- Update Pagination Controls ---
        function updatePaginationControls() {
            const totalPages = Math.ceil(allTrips.length / rowsPerPage);
            pageInfoSpan.textContent = `หน้า ${currentPage} จาก ${totalPages === 0 ? 1 : totalPages}`;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // --- Apply Filters and Re-render ---
        async function applyFilterAndRender() {
            let query = tripsCollection.orderBy('tripDate', 'desc'); // Always order by date for consistency

            const filterDateStart = filterDateStartInput.value;
            const filterDateEnd = filterDateEndInput.value;
            const filterLicensePlate = filterLicensePlateSelect.value;

            if (filterDateStart) {
                query = query.where('tripDate', '>=', filterDateStart);
            }
            if (filterDateEnd) {
                query = query.where('tripDate', '<=', filterDateEnd);
            }
            if (filterLicensePlate) {
                query = query.where('licensePlate', '==', filterLicensePlate);
            }
            
            try {
                const snapshot = await query.get();
                allTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Ensure numeric fields are parsed for calculations later
                allTrips.forEach(trip => {
                    trip.startMileage = parseFloat(trip.startMileage) || 0;
                    trip.endMileage = parseFloat(trip.endMileage) || 0;
                    trip.fuelQuantityLiter = parseFloat(trip.fuelQuantityLiter) || 0;
                    trip.fuelPricePerLiter = parseFloat(trip.fuelPricePerLiter) || 0;
                    trip.fuelCost = parseFloat(trip.fuelCost) || 0; // Already calculated on save
                    trip.otherCostAmount = parseFloat(trip.otherCostAmount) || 0;
                    trip.distanceDriven = parseFloat(trip.distanceDriven) || 0;
                    trip.totalCost = parseFloat(trip.totalCost) || 0;
                });
                
                currentPage = 1; // Reset to first page on filter
                renderTable();
                showToast('แสดงข้อมูลตามตัวกรองแล้ว', 'info');
            } catch (error) {
                console.error("Error applying filters and rendering:", error);
                showToast('เกิดข้อผิดพลาดในการกรองข้อมูล: ' + error.message, 'error');
            }
        }

        // --- Export to Excel ---
        function exportToExcel() {
            if (allTrips.length === 0) {
                showToast('ไม่พบข้อมูลเที่ยววิ่งที่จะส่งออก', 'error');
                return;
            }

            const dataForExcel = allTrips.map(trip => [
                trip.tripDate,
                trip.licensePlate,
                trip.vehicleType || '',
                trip.driverName || '',
                trip.tripType || '',
                trip.startMileage,
                trip.endMileage,
                trip.distanceDriven,
                trip.fuelQuantityLiter,
                trip.fuelPricePerLiter,
                trip.fuelCost,
                trip.otherCostType || '',
                trip.otherCostAmount,
                trip.fuelCost + trip.otherCostAmount
            ]);

            const headers = [
                'วันที่', 'ทะเบียนรถ', 'ประเภทรถ', 'คนขับ', 'ประเภทเที่ยววิ่ง',
                'เลขไมล์เริ่มต้น', 'เลขไมล์สิ้นสุด', 'ระยะทาง (กม.)',
                'จำนวนน้ำมันที่เติม (ลิตร)', 'ราคาน้ำมัน/ลิตร', 'ค่าน้ำมัน (บ.)',
                'ประเภทค่าใช้จ่ายอื่นๆ', 'ค่าใช้จ่ายอื่นๆ (บ.)', 'รวมค่าใช้จ่าย (บ.)'
            ];
            dataForExcel.unshift(headers);

            const ws = XLSX.utils.aoa_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ประวัติเที่ยววิ่ง");
            XLSX.writeFile(wb, `ประวัติเที่ยววิ่ง_${getTodayDateForExcel()}.xlsx`);
            showToast('ส่งออกข้อมูล Excel เรียบร้อยแล้ว!', 'success');
        }


        // --- Event Listeners ---
        licensePlateSelect.addEventListener('change', handleVehicleSelection);
        startMileageInput.addEventListener('input', calculateDistanceAndFuelCost);
        endMileageInput.addEventListener('input', calculateDistanceAndFuelCost);
        fuelQuantityLiterInput.addEventListener('input', calculateDistanceAndFuelCost);
        fuelPricePerLiterInput.addEventListener('input', calculateDistanceAndFuelCost);
        clearFormBtn.addEventListener('click', clearForm);

        applyFilterBtn.addEventListener('click', applyFilterAndRender);
        clearFilterBtn.addEventListener('click', async () => {
            filterDateStartInput.value = '';
            filterDateEndInput.value = '';
            filterLicensePlateSelect.value = '';
            showToast('ล้างตัวกรองแล้ว', 'info');
            await applyFilterAndRender(); // Re-fetch all data after clearing filters
        });
        exportExcelBtn.addEventListener('click', exportToExcel);

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });
        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(allTrips.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            tripDateInput.value = getTodayDate(); // Set default date to today
            await populateVehicleSelects(); // Load vehicles first
            await applyFilterAndRender(); // Then load and render trips
        });

    </script>
</body>
</html>